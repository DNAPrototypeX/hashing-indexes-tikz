% Simple package for drawing Extendible Hashing Indexes using TikZ.
% Layout based on visualizations used in slide set "Hash-Based Indexing" from
% http://db.inf.uni-tuebingen.de/teaching/DatenbanksystemeIISS2016.html.
% Based on weiwBTree.sty from http://www.cse.unsw.edu.au/~weiw/tools.html.

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{exthashidx}

\RequirePackage{tikz}
\RequirePackage{ifthen}

\usetikzlibrary{arrows,shapes,matrix}

% ------------------------------------------------------------------------------

% global style declarations
\tikzstyle{ehiptr} = [draw, semithick, fill=white, minimum height=2em, minimum width=4em]
\tikzstyle{ehival} = [draw, semithick, fill=white, minimum size=2em, font=\ttfamily]
\tikzstyle{ehidepth} = [draw, semithick, fill=gray!40, minimum size=2em, font=\sffamily\bfseries]
\tikzstyle{ehilink} = [draw, semithick, ->, >=triangle 45, shorten >=.5em]
\tikzstyle{ehilabel} = [minimum height=2em, font=\sffamily\bfseries, inner sep=0]
\tikzstyle{ehibin} = [minimum height=2em, font=\ttfamily]

% helper macros (almost verbatim from weiwBTree.sty)
\newcommand{\ehisuppressemptystr}[1]{% leave blank for entries in leaf nodes
  \ifthenelse{\equal{#1}{}}%
  {%
    \relax%
  }%
  % Else
  {%
    #1%\textsuperscript{*}%
  }%
}%

\providecommand{\xyshift}[3]{% help to place the nodes
  \begin{scope}[xshift=#1, yshift=#2]
    #3
  \end{scope}%
}

% ------------------------------------------------------------------------------

% link between directory entry and bucket
\newcommand{\exthashidxlink}[2]{% #1: src node; #2: dest node; 
  \draw[ehilink] (#1.center) -- (#2-a.west);
}

% directory with capacity = 4
\newcommand{\exthashidxdirectoryfour}[2]{%
  \matrix [ampersand replacement=\&, matrix anchor=east, column 2/.style={anchor=base west}] (#1)
  {
    \& \node[ehidepth] (#1-depth) {#2}; \\
    \node[ehibin] {00 \hspace*{1em}}; \& \node[ehiptr] (#1-00) {\relax}; \\
    \node[ehibin] {01 \hspace*{1em}}; \& \node[ehiptr] (#1-01) {\relax}; \\
    \node[ehibin] {10 \hspace*{1em}}; \& \node[ehiptr] (#1-10) {\relax}; \\
    \node[ehibin] {11 \hspace*{1em}}; \& \node[ehiptr] (#1-11) {\relax}; \\
    \& \node[ehilabel] (#1-label) {#1}; \\
  };
}

% directory with capacity = 8
\newcommand{\exthashidxdirectoryeight}[2]{%
  \matrix [ampersand replacement=\&, matrix anchor=east, column 2/.style={anchor=base west}] (#1)
  {
    \& \node[ehidepth] (#1-depth) {#2}; \\
    \node[ehibin] {000 \hspace*{1em}}; \& \node[ehiptr] (#1-000) {\relax}; \\
    \node[ehibin] {001 \hspace*{1em}}; \& \node[ehiptr] (#1-001) {\relax}; \\
    \node[ehibin] {010 \hspace*{1em}}; \& \node[ehiptr] (#1-010) {\relax}; \\
    \node[ehibin] {011 \hspace*{1em}}; \& \node[ehiptr] (#1-011) {\relax}; \\
    \node[ehibin] {100 \hspace*{1em}}; \& \node[ehiptr] (#1-100) {\relax}; \\
    \node[ehibin] {101 \hspace*{1em}}; \& \node[ehiptr] (#1-101) {\relax}; \\
    \node[ehibin] {110 \hspace*{1em}}; \& \node[ehiptr] (#1-110) {\relax}; \\
    \node[ehibin] {111 \hspace*{1em}}; \& \node[ehiptr] (#1-111) {\relax}; \\
    \& \node[ehilabel] (#1-label) {#1}; \\
  };
}

% bucket with capacity = 4
\newcommand{\exthashidxbucketfour}[6]{%
  \matrix [ampersand replacement=\&, matrix anchor=west] (#1)
  {
  	\node[ehidepth] (#1-depth) {#2}; \\
    \node[ehival] (#1-a) {\ehisuppressemptystr{#3}}; \&
    \node[ehival] (#1-b) {\ehisuppressemptystr{#4}}; \&
    \node[ehival] (#1-c) {\ehisuppressemptystr{#5}}; \&
    \node[ehival] (#1-d) {\ehisuppressemptystr{#6}}; \&
    \node[ehilabel] (#1-label) {\hspace*{1em} bucket #1};\\
  };
}

% ------------------------------------------------------------------------------

% example
%\begin{center}
%    \scalebox{0.8}{
%        \begin{tikzpicture}
%            % directory
%            \xyshift{+00mm}{+00mm}{\exthashidxdirectoryeight{directory}{3}}
%            % buckets
%            \xyshift{+20mm}{+60mm}{\exthashidxbucketfour{A}{3}{}{}{64}{16}}
%            \xyshift{+20mm}{+30mm}{\exthashidxbucketfour{B}{2}{1}{5}{21}{}}
%            \xyshift{+20mm}{+00mm}{\exthashidxbucketfour{C}{2}{10}{}{}{}}
%            \xyshift{+20mm}{-30mm}{\exthashidxbucketfour{D}{2}{15}{7}{51}{}}
%            \xyshift{+20mm}{-60mm}{\exthashidxbucketfour{A2}{3}{4}{12}{20}{36}{29}}
%            % links
%            \exthashidxlink{directory-000}{A}
%            \exthashidxlink{directory-001}{B}
%            \exthashidxlink{directory-010}{C}
%            \exthashidxlink{directory-011}{D}
%            \exthashidxlink{directory-100}{A2}
%            \exthashidxlink{directory-101}{B}
%            \exthashidxlink{directory-110}{C}
%            \exthashidxlink{directory-111}{D}
%        \end{tikzpicture}
%    }
%\end{center}
